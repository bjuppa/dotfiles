# Web services

- For PHP 7.3 (optional):
  - List installed PHP packages: `apt list --installed | grep -i php`
  - `sudo add-apt-repository ppa:ondrej/php`
  - `sudo apt update`
  - Check PHP version: `php -v`
  - To remove old php packages: `apt purge ...`
- [Install LEMP stack](https://www.digitalocean.com/community/tutorials/how-to-install-linux-nginx-mysql-php-lemp-stack-ubuntu-18-04):

  - `sudo apt install -y nginx mysql-server php-fpm php-mysql`
  - `sudo mysql_secure_installation`

- Install PHP extensions: `sudo apt install -y php-mbstring php-xml php-zip php-bcmath`
- [Add missing font mime types to nginx](https://github.com/fontello/fontello/wiki/How-to-setup-server-to-serve-fonts)
  by editing `/etc/nginx/mime.types`, search for `woff` and ensure:

      font/ttf    ttf;
      font/otf    otf;
      font/woff   woff;
      font/woff2  woff2;

- [Enable all gzip directives](https://www.digitalocean.com/community/tutorials/how-to-add-the-gzip-module-to-nginx-on-ubuntu-16-04)
  in `/etc/nginx/nginx.conf` and ensure `gzip_min_length` and `gzip_types`:

        gzip on;

        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_buffers 16 8k;
        gzip_http_version 1.1;
        gzip_min_length 256;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;

- Put [files](../nginx/snippets/) in `/etc/nginx/snippets`
- Add this _last_ in `/etc/sudoers` using `sudo visudo`:

      # Allow members of group www-data to reload php
      %www-data ALL=(ALL:ALL) NOPASSWD: /bin/systemctl reload php7.3-fpm

- [DO: Install `composer`](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-composer-on-ubuntu-18-04)
- [DO: Install `node` and `npm`](https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-18-04)

## Configure a new Laravel site

- Add a file from [template](../nginx/sites-available/laravel-site) in `/etc/nginx/sites-available`
- Link the site config file into `/etc/nginx/sites-enabled`
- `sudo nginx -t` to test and then `sudo systemctl reload nginx` to enable the new config
- Add user to group `www-data` using `sudo usermod -G www-data -a 'name-of-user'`
- Set up [Laravel's scheduled tasks](https://laravel.com/docs/scheduling) to run as the webserver user:
  `sudo crontab -e -u www-data`

- [Certbot for https](https://certbot.eff.org/#ubuntuxenial-nginx)
- [DO: HTTP/2 with nginx](https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-with-http-2-support-on-ubuntu-18-04)
- Optimize fpm processes in `/etc/php/7.3/fpm/pool.d`
- Optimize Opcache in `/etc/php/7.3/fpm/php.ini`
- Optimize MySQL using [Percona](https://www.percona.com/doc/percona-toolkit/LATEST/installation.html)
